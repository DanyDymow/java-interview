## Two Phase Commit

Two-Phase Commit (2PC) - это протокол для координации распределенных транзакций в системах с несколькими узлами данных, где транзакции могут затрагивать данные на нескольких узлах. Он используется для обеспечения атомарности (либо все операции выполнены успешно, либо ни одна) и согласованности (данные остаются в согласованном состоянии) таких транзакций. Вот основные концепции и этапы Two-Phase Commit:

Подготовка (Prepare Phase):
Координатор (обычно называемый Transaction Manager) отправляет запрос на подготовку (prepare request) всем участникам транзакции.
Участники транзакции выполняют необходимые операции и готовятся к фиксации (commit) или откату (abort) транзакции.
Если участник успешно завершил все операции и готов к фиксации, он отправляет подтверждение (acknowledgement) координатору.
Коммит (Commit Phase):
Если все участники транзакции успешно подтвердили готовность к фиксации, координатор отправляет команду на фиксацию (commit command) всем участникам.
Участники выполняют команду на фиксацию, сохраняя изменения в постоянном хранилище данных.
После фиксации транзакции участники отправляют подтверждение координатору.
Откат (Abort Phase):
Если хотя бы один участник сообщил о неудачной подготовке или фиксации, либо координатор не получил подтверждения от всех участников, он отправляет команду на откат (abort command) всем участникам.
Участники отменяют все изменения, связанные с транзакцией, и возвращаются к предыдущему состоянию.
После отката транзакции участники отправляют подтверждение координатору.
Важно отметить, что Two-Phase Commit гарантирует атомарность и согласованность распределенных транзакций в системе, но за счет этого он также может приводить к проблемам с производительностью и отказоустойчивостью из-за блокировки ресурсов во время ожидания подтверждений. Кроме того, он не защищает от сетевых сбоев или неполадок в системе.





Двухфазный коммит
2 Phase Commit - 2PC

Технические требования для имплементации 2PC:

наличие менеджера транзакций, например Narayana

надежное хранилище транзакционных логов

все бд, к которым подключены микросервисы должны иметь совместимость со стандартном DTP XA (distributed transaction processing) (XA - extended architecture), а также mq и кеши должны поддерживать XA драйвер

если у вас есть все необходимое, но при этом приложение деплоится в динамическое окружение, такое как Kubernetes, вам понадобиться некий управляющий механизм, который будет гарантировать, что есть только один экземпляр менеджера распределенных транзакций. Транзакционный менеджер должен быть всегда доступен и для него всегда должен быть обеспечен доступ к транзакционным логам. Пример Snowdrop Recovery Controller

Пример работы 2PC в статье описан очень плохо, поэтому описание алгоритма 2PC взято из другого источника.

Код приложения в первую очередь обращается к координатору, получает номер транзакции.

С этим номером обращается к остальным системам, например к нескольким разным микросервисам, просит их внести изменения с указанным идентификатором транзакции

Затем приложение обращается к координатору с просьбой закоммитить транзакцию, после чего координатор сначала отправляет всем сигнал prepare, если все сервисы ответили успехом (они захватили write locks на своих бд), то им посылается сигнал commit.


Теперь транзакция завершена.

Протокол двухфазного коммита появился в 70-х годах.

Двухфазный коммит предлагает те же гарантии что и единая транзакция в монолите, разве что возможны ошибки в данных при падении транзакционного менеджера.

Плюсы 2PC
является стандартным решением, существуют готовые менеджеры транзакций и множество бд его поддерживают

строгая консистентность данных

Минусы 2PC
сложная конфигурация

низкая производительность

ограниченная масштабируемость (практически невозможно масштабировать)

возможные отказы, при падении менеджера транзакций

не все системы имеют поддержку (например NoSQL не интегрируются, mq или кеши могут не поддерживать спецификацию)

особые требования в динамических окружениях, таких как Kubernetes








